# Tool Server Container
#
# Executes tool commands on behalf of the Claude client container.
# Tools are auto-discovered from /app/tools.d/ at startup.
#
# To add a new tool, create a directory in tools.d/ with a tool.json:
#   tools.d/mytool/tool.json  -> {"binary": "/usr/bin/mytool", "timeout": 300}
#   tools.d/mytool/setup.sh   -> (optional) runs at container start
#   tools.d/mytool/restricted.sh -> (optional) restriction wrapper
#
# To add global permission restrictions, create a wrapper script
# in /app/restricted/ named {tool}.sh or {tool}.py.

FROM python:3.12-slim

# Install tools (add more as needed)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 -s /bin/bash tools

# Create directories
RUN mkdir -p /run/sockets /workspace /app/tools.d /app/restricted \
    && chown -R tools:tools /run/sockets /workspace /app

# Copy server code and tool caller
COPY tool-server/server.py /app/server.py
COPY tool-server/tool-caller.py /app/tool_caller.py
COPY tool-server/tool-setup.sh /app/tool-setup.sh
COPY tool-server/__init__.py /app/__init__.py

# Copy tool definitions (auto-discovered at startup)
COPY tools.d/ /app/tools.d/

# Make scripts executable
RUN chmod +x /app/tool-setup.sh \
    && find /app/tools.d -name '*.sh' -exec chmod +x {} + 2>/dev/null || true

# Set ownership
RUN chown -R tools:tools /app

# Environment
ENV TOOL_SOCKET=/run/sockets/tool.sock
ENV PYTHONUNBUFFERED=1
ENV WORKSPACE=/workspace
ENV RESTRICTED_DIR=/app/restricted
ENV TOOLS_DIR=/app/tools.d

# Switch to non-root user
USER tools
WORKDIR /workspace

# Use setup script as entrypoint, server as default command
ENTRYPOINT ["/app/tool-setup.sh"]
CMD ["python3", "/app/server.py"]
