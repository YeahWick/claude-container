# CLI Server Container
#
# Unified command execution server that handles all tool requests.
# Add tools by updating ALLOWED_TOOLS in server.py.

FROM python:3.12-slim

# Install tools (add more as needed)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 -s /bin/bash cli

# Create directories
RUN mkdir -p /run/plugins /workspace /app/setup.d \
    && chown -R cli:cli /run/plugins /workspace /app

# Copy server code and tool caller
COPY plugins/cli/server.py /app/server.py
COPY plugins/cli/tool-caller.py /app/tool_caller.py
COPY plugins/cli/tool-setup.sh /app/tool-setup.sh

# Make setup script executable
RUN chmod +x /app/tool-setup.sh

# Set ownership
RUN chown -R cli:cli /app

# Environment
ENV CLI_SOCKET=/run/plugins/cli.sock
ENV PYTHONUNBUFFERED=1
ENV WORKSPACE=/workspace
ENV TOOL_CALLER_MODE=default

# Switch to non-root user
USER cli
WORKDIR /workspace

# Use setup script as entrypoint, server as default command
ENTRYPOINT ["/app/tool-setup.sh"]
CMD ["python3", "/app/server.py"]
