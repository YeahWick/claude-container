# Git Plugin Container
#
# Provides git functionality via Unix socket with:
# - Branch protection via git hooks
# - Command validation before execution
# - Credential injection for GitHub authentication

FROM python:3.12-slim

# Install git
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 -s /bin/bash plugin

# Create directories
RUN mkdir -p /run/plugins /etc/plugins /var/lib/git-plugin/hooks /workspace \
    && chown -R plugin:plugin /run/plugins /var/lib/git-plugin /workspace

# Install Python dependencies
RUN pip install --no-cache-dir pyyaml

# Copy plugin code
COPY plugins/base /app/plugins/base
COPY plugins/git /app/plugins/git

# Set ownership
RUN chown -R plugin:plugin /app

# Environment
ENV PLUGIN_SOCKET=/run/plugins/git.sock
ENV PLUGIN_CONFIG=/etc/plugins/git.yaml
ENV PYTHONPATH=/app

# Switch to non-root user
USER plugin
WORKDIR /workspace

# Start plugin server
CMD ["python", "/app/plugins/git/main.py"]
