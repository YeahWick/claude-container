# Claude Container v2 - Simplified CLI Architecture
#
# This compose file sets up:
# - Claude container (CLI with simple wrapper)
# - CLI server (handles all tool execution via Unix socket)
#
# Communication: Containers share a Unix socket at /run/plugins/cli-{instance}.sock
#
# Tool auto-discovery:
# - Tools are defined in tools.d/ (baked into image at build, or mounted at runtime)
# - Server auto-registers tools from /app/tools.d/ at startup
# - Claude container auto-generates CLI symlinks from /app/tools.d/
# - To add a tool: create tools.d/{name}/tool.json (no code changes needed)
#
# Concurrent Instances:
# - INSTANCE_ID must be set (run.sh generates from PROJECT_DIR hash)
# - COMPOSE_PROJECT_NAME namespaces containers (e.g., "claude-abc123")
# - Each PROJECT_DIR gets a unique instance based on path hash
# - Container names are auto-generated as {project}_{service}_{replica}

services:
  # Claude Code container - minimal, just runs wrapper commands
  claude:
    build:
      context: .
      dockerfile: claude/Containerfile
    image: claude-code:v2
    stdin_open: true
    tty: true
    volumes:
      # CLI wrappers - host directory mounted into PATH
      - ${CLAUDE_HOME:-~/.claude-container}/cli:/home/claude/bin:ro
      # Plugin sockets - read-only access
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:ro
      # Tool definitions - for auto-generating symlinks
      - ${CLAUDE_HOME:-~/.claude-container}/tools.d:/app/tools.d:ro
      # Workspace - project directory
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - PATH=/home/claude/bin:/usr/local/bin:/usr/bin:/bin
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Socket path includes instance ID (required, no default)
      - CLI_SOCKET=/run/plugins/cli-${INSTANCE_ID}.sock
      - TOOLS_DIR=/app/tools.d
    working_dir: /workspace
    depends_on:
      - cli-server

  # CLI server - handles all tool execution with restrictions
  cli-server:
    build:
      context: .
      dockerfile: plugins/cli/Containerfile
    image: cli-server:v2
    volumes:
      # Plugin sockets - read-write to create socket
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:rw
      # Tool definitions - for auto-discovery and setup scripts
      - ${CLAUDE_HOME:-~/.claude-container}/tools.d:/app/tools.d:ro
      # Workspace - same as claude container
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GH_TOKEN=${GH_TOKEN:-${GITHUB_TOKEN}}
      # Socket path includes instance ID (required, no default)
      - CLI_SOCKET=/run/plugins/cli-${INSTANCE_ID}.sock
      - TOOLS_DIR=/app/tools.d
    working_dir: /workspace
    healthcheck:
      test: ["CMD", "python3", "-c", "import os; import socket; s=socket.socket(socket.AF_UNIX); s.connect(os.environ['CLI_SOCKET']); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
