# Claude Container v2 - Plugin Socket Architecture
#
# This compose file sets up:
# - Claude container (CLI with plugin wrappers)
# - Git plugin (socket-based git with branch protection)
#
# Add more plugins by adding new services and mounting their sockets.

services:
  # Claude Code container - minimal, no direct tool access
  claude:
    build:
      context: .
      dockerfile: claude/Containerfile
    image: claude-code:v2
    container_name: claude
    stdin_open: true
    tty: true
    volumes:
      # CLI wrappers - host directory mounted into PATH
      - ${CLAUDE_HOME:-~/.claude-container}/cli:/home/claude/bin:ro
      # Plugin sockets - read-only access
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:ro
      # Workspace - project directory
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - PATH=/home/claude/bin:/usr/local/bin:/usr/bin:/bin
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    working_dir: /workspace
    networks:
      - plugin-net
    depends_on:
      - git-plugin

  # Git plugin - provides git with branch protection
  git-plugin:
    build:
      context: .
      dockerfile: plugins/git/Containerfile
    image: plugin-git:v2
    container_name: git-plugin
    volumes:
      # Plugin sockets - read-write to create socket
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:rw
      # Plugin config - configuration file
      - ${CLAUDE_HOME:-~/.claude-container}/config:/etc/plugins:ro
      # Workspace - same as claude container for git operations
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GH_TOKEN=${GH_TOKEN:-${GITHUB_TOKEN}}
      - PLUGIN_SOCKET=/run/plugins/git.sock
      - PLUGIN_CONFIG=/etc/plugins/git.yaml
    working_dir: /workspace
    networks:
      - plugin-net
    # Capability for memory locking (credentials)
    cap_add:
      - IPC_LOCK
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(socket.AF_UNIX); s.connect('/run/plugins/git.sock'); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  plugin-net:
    driver: bridge
