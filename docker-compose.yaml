# Claude Container v2 - Simplified CLI Architecture
#
# This compose file sets up:
# - Claude container (CLI with simple wrapper)
# - CLI server (handles all tool execution via Unix socket)
#
# Communication: Containers share a Unix socket at /run/plugins/cli.sock
# To add tools: Update create_default_caller() in plugins/cli/tool-caller.py

services:
  # Claude Code container - minimal, just runs wrapper commands
  claude:
    build:
      context: .
      dockerfile: claude/Containerfile
    image: claude-code:v2
    container_name: claude
    stdin_open: true
    tty: true
    volumes:
      # CLI wrappers - host directory mounted into PATH
      - ${CLAUDE_HOME:-~/.claude-container}/cli:/home/claude/bin:ro
      # Plugin sockets - read-only access
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:ro
      # Workspace - project directory
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - PATH=/home/claude/bin:/usr/local/bin:/usr/bin:/bin
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    working_dir: /workspace
    depends_on:
      - cli-server

  # CLI server - handles all tool execution with restrictions
  cli-server:
    build:
      context: .
      dockerfile: plugins/cli/Containerfile
    image: cli-server:v2
    container_name: cli-server
    volumes:
      # Plugin sockets - read-write to create socket
      - ${CLAUDE_HOME:-~/.claude-container}/sockets:/run/plugins:rw
      # Workspace - same as claude container
      - ${PROJECT_DIR:-.}:/workspace
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GH_TOKEN=${GH_TOKEN:-${GITHUB_TOKEN}}
      - CLI_SOCKET=/run/plugins/cli.sock
    working_dir: /workspace
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(socket.AF_UNIX); s.connect('/run/plugins/cli.sock'); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
