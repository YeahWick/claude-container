# Claude Code Container with Command Agent
# Simple two-container setup:
# - command-agent: Executes git/gh commands with credentials and restrictions
# - claude: Claude Code with CLI wrappers that forward to agent
#
# Usage:
#   podman-compose up -d
#   podman-compose exec claude bash
#   podman-compose down

services:
  command-agent:
    build:
      context: ./command-agent
      dockerfile: Containerfile
    container_name: claude-command-agent
    restart: unless-stopped
    environment:
      # Credentials (loaded then cleared from env)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # Branch protection
      - BLOCKED_BRANCHES=${BLOCKED_BRANCHES:-["main","master"]}
      - ALLOWED_BRANCH_PATTERNS=${ALLOWED_BRANCH_PATTERNS:-[]}
      # Agent config
      - AGENT_ALLOWED_UIDS=1000
      - AGENT_DEBUG=${AGENT_DEBUG:-false}
    volumes:
      - agent-socket:/run/agent
      - ${PROJECT_DIR:-.}:/workspace:Z
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK
    read_only: true
    tmpfs:
      - /tmp:size=10M,mode=1777
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(socket.AF_UNIX); s.connect('/run/agent/cmd.sock'); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  claude:
    build:
      context: .
      dockerfile: Containerfile
    container_name: claude-code
    stdin_open: true
    tty: true
    environment:
      - AGENT_SOCKET=/run/agent/cmd.sock
      - WORKSPACE=/home/claude/workspace
    volumes:
      - ${PROJECT_DIR:-.}:/home/claude/workspace:Z
      - ${ANTHROPIC_KEY_FILE:-~/.anthropic_key}:/home/claude/.anthropic_key:ro
      - agent-socket:/run/agent:ro
    depends_on:
      command-agent:
        condition: service_healthy

volumes:
  agent-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1M,uid=1000,gid=1000
