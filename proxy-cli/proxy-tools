#!/bin/bash
# Claude Code Proxy - Tool Discovery
# Lists all available tools and their CLI commands

set -e

# Configuration
PROXY_HOST="${PROXY_HOST:-proxy}"
PROXY_PORT="${PROXY_PORT:-8080}"
PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo -e "${BOLD}${CYAN}$1${NC}"
}

print_tool() {
    echo -e "  ${GREEN}$1${NC} - $2"
}

print_command() {
    echo -e "    ${YELLOW}$1${NC}"
}

print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

# Check if proxy is available
check_proxy() {
    if ! curl -s --connect-timeout 2 "${PROXY_URL}/health" > /dev/null 2>&1; then
        echo -e "${YELLOW}Note: Proxy server not currently available at ${PROXY_URL}${NC}"
        echo "Start the proxy container to use these tools."
        echo
        return 1
    fi
    return 0
}

show_local_tools() {
    print_header "Available Proxy CLI Tools"
    echo

    echo -e "${BOLD}General:${NC}"
    print_tool "proxy-cli" "Main CLI for proxy interaction"
    print_command "proxy-cli tools      # List server tools"
    print_command "proxy-cli tool NAME  # Get tool details"
    print_command "proxy-cli health     # Check proxy health"
    echo

    echo -e "${BOLD}proxy-tools${NC} (this command)"
    print_command "proxy-tools          # List available CLI tools"
    print_command "proxy-tools --check  # Check proxy status"
    echo

    print_header "Tool-Specific CLIs"
    echo

    echo -e "${BOLD}GitHub (proxy-github):${NC}"
    print_tool "proxy-github" "Git operations with branch protection"
    print_command "proxy-github help              # Full help"
    print_command "proxy-github status            # Git status"
    print_command "proxy-github push origin BRANCH"
    print_command "proxy-github pull"
    print_command "proxy-github clone URL"
    print_command "proxy-github branches"
    print_command "proxy-github blocked           # Show protected branches"
    print_command "proxy-github check BRANCH      # Check if push allowed"
    echo
}

show_server_tools() {
    echo
    print_header "Server-Side Tools"
    echo

    local response
    response=$(curl -s "${PROXY_URL}/tools")

    if command -v jq &> /dev/null; then
        echo "$response" | jq -r '.available_tools | to_entries[] | "  \(.key): \(.value.description)"'
        echo
        echo "Use 'proxy-cli tool NAME' for detailed endpoint information"
    else
        echo "$response"
    fi
}

main() {
    case "${1:-}" in
        --check|-c)
            if check_proxy; then
                echo -e "${GREEN}Proxy is running at ${PROXY_URL}${NC}"
                curl -s "${PROXY_URL}/health" | jq . 2>/dev/null || curl -s "${PROXY_URL}/health"
            else
                exit 1
            fi
            ;;
        --server|-s)
            if check_proxy; then
                show_server_tools
            fi
            ;;
        --help|-h)
            cat << EOF
Usage: proxy-tools [option]

Options:
  (none)      Show available CLI tools
  --check     Check proxy server status
  --server    Show server-side tools
  --help      Show this help

Environment:
  PROXY_HOST  Proxy hostname (default: proxy)
  PROXY_PORT  Proxy port (default: 8080)
EOF
            ;;
        *)
            show_local_tools

            if check_proxy 2>/dev/null; then
                show_server_tools
            fi
            ;;
    esac
}

main "$@"
